services:
  - "microsoft/mssql-server-linux"
  - "mysql"
  - "postgres:alpine"

variables:
  ACCEPT_EULA: "Y"
  SA_PASSWORD: "7wnjijM9JihtKok4RC6"
  MYSQL_ROOT_PASSWORD: "my-secret-pw"
  POSTGRES_PASSWORD: "my-secret-pw"

.build_tpl: &build_tpl
  stage: build
  script:
   - apk add --no-cache git
   - npm install -q -g @openmicrostep/msbuildsystem.cli@^0.5.0 @openmicrostep/tests istanbul coveralls remap-istanbul
   - msbuildsystem modules install @openmicrostep/msbuildsystem.js.typescript@^0.5.0
   - git clone https://github.com/OpenMicroStep/MSBuildSystem.git
   - msbuildsystem build -w dist/gitlab/ --target build --env gitlab --no-progress

build-6:
  <<: *build_tpl
  image: node:6-alpine

build-8:
  <<: *build_tpl
  image: node:8-alpine

deploy:
  stage: deploy
  image: node:6-alpine
  only:
    - tags
  script:
   - echo "$NPM_AUTH" >> ~/.npmrc
   - apk add --no-cache git python g++
   - npm install -q -g @openmicrostep/msbuildsystem.cli@^0.5.0 @openmicrostep/tests istanbul coveralls remap-istanbul
   - msbuildsystem modules install @openmicrostep/msbuildsystem.js.typescript@^0.5.0
   - git clone https://github.com/OpenMicroStep/MSBuildSystem.git
   - msbuildsystem build -w dist/gitlab/ --target deploy --env gitlab --no-progress
