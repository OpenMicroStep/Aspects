before_script:
 - npm set registry $NPM_REGISTRY

build:
  image: node:6-alpine
  stage: build
  script:
   - npm install -q -g @openmicrostep/msbuildsystem.cli
   - msbuildsystem modules install @openmicrostep/msbuildsystem.js.typescript @openmicrostep/msbuildsystem.aspects @openmicrostep/msbuildsystem.js.logitud
   - msbuildsystem build -w dist/
  artifacts:
    expire_in: 31d
    paths:
     - dist/

test:
  image: node:6-alpine
  stage: test
  dependencies:
   - build
  script:
   - npm install -q -g @openmicrostep/tests
   - mstests dist/js/debug/node_modules/@openmicrostep/aspects.tests/typescript/core/tst/core.spec.js 
             dist/js/debug/node_modules/@openmicrostep/aspects.sequelize.tests/typescript/datasource.sequelize/tst/datasource.sequelize.spec.js

publish:
  image: node:6-alpine
  stage: deploy
  script:
    - echo "$NPM_AUTH" >> ~/.npmrc
    - npm publish dist/js/debug/node_modules/@openmicrostep/aspects
    - npm publish dist/js/debug/node_modules/@openmicrostep/aspects.express
    - npm publish dist/js/debug/node_modules/@openmicrostep/aspects.sequelize
    - npm publish dist/js/debug/node_modules/@openmicrostep/aspects.xhr
  dependencies:
   - build
  only:
    - master
  when: manual
  environment: production
